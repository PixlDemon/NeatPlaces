<html>
    <head>
        <title>NeatPlaces</title>
        <meta name="viewport" content="initial-scale=1.0">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
		<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
        <style>
            #map {
                height: 500px;
				width: 500px;
				float: left;
            }
			#forms {
				float: left;
				margin: 50px;
			}
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
			p {
				font-family: "Tahoma", Geneva, sans-serif;
				font-size: 11px;
				font-weight: bold;
			}
			input[type="text"], textarea {
				padding: 6px;
				width: 200px;
				border-radius: 5px;
				border: 1px solid grey;
			}
			button {
				padding: 10px;
				border-radius: 5px;
			}
			input:focus {
				outline: none;
			}
			textarea:focus {
				outline: none;
			}
			button:focus {
				outline: none;
			}
        </style>
    </head>
    <body>
		<div id="map"></div>
		<div id="forms">
			<p>Location Coordinates</p>
			<div style="margin:10px"><p id="lat">Latitude: </p><p id="long">Longitude: </p></div>
			<p>Location Name</p>
			<input id="locationname" type="text" placeholder="Pick a name for this location!">
			<p>Location Type</p>
			<select id="locationtype">
				<option value="food">Restaurant</option>
				<option value="club">Club</option>
				<option value="shop">Shop</option>
				<option value="museum">Museum</option>
				<option value="other">Other</option>
			</select>
			<p>Location Description</p>
			<textarea id="locationdescription" rows="10" cols="50" placeholder="Describe this location!" style="resize: none;"></textarea><br>
			<button onclick="App.submitLocationData();" style="margin-top: 10px;">Submit!</button>
		</div>
		<script>
			let socket = new WebSocket("ws://127.0.0.1:8000");
			let places = [];
			
			socket.onopen = e => {

			}
			socket.onmessage = m => {
				if(true) {
					data = JSON.parse(m.data);
					let place = new Place(data.lat, data.long, data.name, data.type, data.description, data.creator);
				}
			}
			let username;
			let App = {
				ui: {
					reset() {
						App.ui.locationname.value = App.ui.locationdescription.value = "";
						App.ui.longitude.innerHTML = "Longitude: ";
						App.ui.latitude.innerHTML = "Latitude: ";
						App.ui.locationtype.selectedIndex = 0;
						App.ui.map.removeLayer(App.ui.indicator);
					}
				},
				init() {
					if(true) {//!localStorage.value) {
						username = prompt("Pick a username!");
						localStorage.value = username;
					} else {
						username = localStorage.value;
					}
					places = [];
					App.ui.longitude = document.getElementById("long");
					App.ui.latitude = document.getElementById("lat");
					App.ui.locationname = document.getElementById("locationname");
					App.ui.locationtype = document.getElementById("locationtype");
					App.ui.locationdescription = document.getElementById("locationdescription");


					App.ui.map = L.map("map").setView([52.5077302, 13.469056], 20);
					let mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';

        			L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        				attribution: 'Map data &copy; ' + mapLink,
        				maxZoom: 18,
					}).addTo(App.ui.map);

					App.ui.markerIcon = new L.Icon({
						iconUrl: "map-marker.png",
						iconSize: [41, 41],
						iconAnchor: [20, 51],
						popupAnchor: [0, -51]                                 
					});
					App.ui.indicatorIcon = new L.Icon({
						iconUrl: "indicator.png",
						iconSize: [41, 41],
						iconAnchor: [20, 51],
						popupAnchor: [0, -51]  
					})

					App.ui.map.on("click", App.clickHandler);

					document.onkeydown = (e) => {
						console.log(e.keyCode);
						if(e.keyCode == 13) {
							App.submitLocationData();
						}
					}
				},
				clickHandler(e) {
					App.ui.longitude.innerHTML="Longitude: " + e.latlng.lng;
					App.ui.latitude.innerHTML="Latitude: " + e.latlng.lat;

					if(!App.ui.indicator) {
						App.ui.indicator = L.marker([e.latlng.lat, e.latlng.lng], {icon: App.ui.indicatorIcon}).addTo(App.ui.map);
					} else {
						App.ui.indicator.setLatLng(e.latlng);
					}

					if(!App.ui.map.hasLayer(App.ui.indicator)) {
						App.ui.indicator.addTo(App.ui.map);
					}
				},
				submitLocationData() {
					if(App.ui.longitude.innerHTML == "Longitude: ") {
						alert("Please click somewhere on the map first!");
						return;
					}
					if([App.ui.locationname, App.ui.locationdescription].some(e=>e.value=="")) {
						alert("Please fill out all the fields");
						return;
					}
					socket.send(JSON.stringify({
						lat:parseFloat(App.ui.longitude.innerHTML.split("Longitude: ")[1]),
						long:parseFloat(App.ui.latitude.innerHTML.split("Latitude: ")[1]),
						name:App.ui.locationname.value,
						type:App.ui.locationtype.options[App.ui.locationtype.selectedIndex].text,
						description:App.ui.locationdescription.value,
						creator:username
					}));
					App.ui.reset();
				}
			}

			class Place {
				constructor(lat, long, name, type, description, creator) {
					Object.assign(this, {lat, long, name, type, description, creator});
					places.push(this);

					this.marker = L.marker([this.long, this.lat], {icon: App.ui.markerIcon}).addTo(App.ui.map);
					this.marker.bindPopup(this.getPopupHtml());
				}
				getPopupHtml() {
					let html = 
					"<p style='font-size: 11px; margin: 3px; font-weight: bold;'>" + this.name + "</p>" +
					"<p style='font-size: 10px; margin: 3px; margin-bottom: 10px; font-weight: normal;'>" + this.type + "</p>" +
					"<p style='font-size: 11px; margin: 3px; font-weight: normal;'>" + this.description + "</p>" +
					"<p style='font-size: 11px; margin: 3px; font-weight: normal;'>" + this.name + "</p>" +
					"<p style='font-size: 8px; margin: 3px; margin-top: 15px; font-weight: normal;'>Submitted by " + this.creator + "</p>";

					return html;
				}
			}

			App.init();
		</script>
    </body>
</html>
